/*var data1 = {
    "errorCode": 1,
    "functionNO": 7009,
    "isLastPack": 1,
    "jData": {
        "1": "1",
        "15": "20161031194244168",
        "3": "7009",
        "5": "-43",
        "6": "6",
        "data": [
            {
                "135": "2000.00",
                "136": "17.777",
                "137": "2000",
                "138": "",
                "139": "15.408",
                "140": "30816.96",
                "141": "",
                "142": "36940.00",
                "143": "",
                "145": "0",
                "151": "0",
                "512": "002088",
                "513": "鲁阳节能",
                "52": "0132233811",
                "54": "SZSE-A",
                "55": "深圳A",
                "56": "0",
                "57": "人民币",
                "614": ""
            },
            {
                "135": "14000.00",
                "136": "12.037",
                "137": "14000",
                "138": "",
                "139": "33.037",
                "140": "462515.49",
                "141": "",
                "142": "166460.00",
                "143": "",
                "145": "0",
                "151": "0",
                "512": "002240",
                "513": "威华股份",
                "52": "0132233811",
                "54": "SZSE-A",
                "55": "深圳A",
                "56": "0",
                "57": "人民币",
                "614": ""
            },
            {
                "135": "5800.00",
                "136": "72.634",
                "137": "5800",
                "138": "",
                "139": "72.913",
                "140": "422893.36",
                "141": "",
                "142": "410988.00",
                "143": "",
                "145": "0",
                "151": "0",
                "512": "002802",
                "513": "洪汇新材",
                "52": "0132233811",
                "54": "SZSE-A",
                "55": "深圳A",
                "56": "0",
                "57": "人民币",
                "614": ""
            },
            {
                "135": "8000.00",
                "136": "27.791",
                "137": "8000",
                "138": "",
                "139": "27.676",
                "140": "221411.12",
                "141": "",
                "142": "215040.00",
                "143": "",
                "145": "0",
                "151": "0",
                "512": "300441",
                "513": "鲍斯股份",
                "52": "0132233811",
                "54": "SZSE-A",
                "55": "深圳A",
                "56": "0",
                "57": "人民币",
                "614": ""
            },
            {
                "135": "18000.00",
                "136": "8.370",
                "137": "18000",
                "138": "",
                "139": "7.895",
                "140": "142108.46",
                "141": "",
                "142": "141840.00",
                "143": "",
                "145": "0",
                "151": "0",
                "512": "600537",
                "513": "亿晶光电",
                "52": "A755651023",
                "54": "SHSE-A",
                "55": "上海A",
                "56": "0",
                "57": "人民币",
                "614": ""
            },
            {
                "135": "1000.00",
                "136": "14.390",
                "137": "1000",
                "138": "",
                "139": "14.390",
                "140": "14390.00",
                "141": "",
                "142": "20720.00",
                "143": "",
                "145": "0",
                "151": "0",
                "512": "600926",
                "513": "N杭银",
                "52": "A755651023",
                "54": "SHSE-A",
                "55": "上海A",
                "56": "0",
                "57": "人民币",
                "614": ""
            }
        ]
    },
    "moduleId": 90002,
    "requestNO": 24,
    "reservId": 1,
    "size": 1637
};

var data2 = {"moduleId":90002,"reservId":1,"requestNO":28,"errorCode":1,"jData":{"data":[{"144":"409825.87","135":"100","145":"100","138":"6.830","57":"人民币","139":"4098.259","56":"0","136":"10.583","137":"0","153":"0","151":"0","64":"深圳能源","52":"0600812799","63":"000027","54":"SZSE-A","140":"4098.259","142":"678.00"},{"144":"211283.20","135":"28000","145":"28000","138":"5.690","57":"人民币","139":"7.546","56":"0","136":"5.889","137":"0","153":"0","151":"0","64":"西部创业","52":"0600812799","63":"000557","54":"SZSE-A","140":"7.546","142":"159600.00"},{"144":"1044894.78","135":"82000","145":"82000","138":"11.890","57":"人民币","139":"12.743","56":"0","136":"13.154","137":"0","153":"0","151":"0","64":"威华股份","52":"0600812799","63":"002240","54":"SZSE-A","140":"12.743","142":"958580.00"},{"144":"-138034.37","135":"68000","145":"68000","138":"10.270","57":"人民币","139":"-2.030","56":"0","136":"9.656","137":"0","153":"0","151":"0","64":"胜利精密","52":"0600812799","63":"002426","54":"SZSE-A","140":"-2.030","142":"680680.00"},{"144":"356.60","135":"150","145":"150","138":"2.305","57":"人民币","139":"2.377","56":"0","136":"2.377","137":"0","153":"150","151":"0","64":"50ETF","52":"E008103632","63":"510050","54":"SHSE-A","140":"2.377","142":"338.55"},{"144":"1198.03","135":"150","145":"150","138":"7.620","57":"人民币","139":"7.987","56":"0","136":"7.987","137":"0","153":"150","151":"0","64":"东风汽车","52":"E008103632","63":"600006","54":"SHSE-A","140":"7.987","142":"1170.00"},{"144":"359.51","135":"50","145":"50","138":"7.150","57":"人民币","139":"7.190","56":"0","136":"7.190","137":"0","153":"50","151":"0","64":"华能国际","52":"E008103632","63":"600011","54":"SHSE-A","140":"7.190","142":"355.50"},{"144":"1236.02","135":"100","145":"100","138":"13.050","57":"人民币","139":"12.360","56":"0","136":"12.360","137":"0","153":"100","151":"0","64":"皖通高速","52":"E008103632","63":"600012","54":"SHSE-A","140":"12.360","142":"1233.00"},{"144":"775.52","135":"50","145":"50","138":"16.490","57":"人民币","139":"15.510","56":"0","136":"15.510","137":"0","153":"50","151":"0","64":"宝硕股份","52":"E008103632","63":"600155","54":"SHSE-A","140":"15.510","142":"795.50"},{"144":"64691.68","135":"8600","145":"8600","138":"7.680","57":"人民币","139":"7.522","56":"0","136":"7.835","137":"0","153":"100","151":"0","64":"亿晶光电","52":"E008103632","63":"600537","54":"SHSE-A","140":"7.522","142":"67940.00"},{"144":"569152.50","135":"33000","145":"33000","138":"9.400","57":"人民币","139":"17.247","56":"0","136":"7.966","137":"0","153":"0","151":"0","64":"中国嘉陵","52":"E008103632","63":"600877","54":"SHSE-A","140":"17.247","142":"288750.00"},{"144":"1920.55","135":"350","145":"350","138":"5.280","57":"人民币","139":"5.487","56":"0","136":"5.487","137":"0","153":"350","151":"0","64":"中信重工","52":"E008103632","63":"601608","54":"SHSE-A","140":"5.487","142":"1844.50"}],"3":"6014","1":"1","15":"20161031194437286","6":"12","5":"-43"},"isLastPack":1,"size":2963,"functionNO":6014};*/
/*function cancel() {
  $('.my-modal').addClass('hide');
}*/




/*callback(JSON.stringify(data1));*/
var isApp = typeof pbE != 'undefined';
if (typeof pbE == 'undefined') {
    window.pbE = {
        WT: function () {
            var obj = {
                wtGetCurrentConnectionCID: function () {},
                wtGeneralRequest: function () {
                  var data = {functionNO: '7000',
                              moduleId: 90002,
                              jData:{'1': 1,
                                     'data': [
                                       {'54': '上海', '55':'HZ', '512':'CU1788', '513':'沪铜1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1789', '513':'沪银1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1786', '513':'铅铝1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1785', '513':'石油1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1788', '513':'沪铜1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1789', '513':'沪银1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1786', '513':'铅铝1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1785', '513':'石油1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1788', '513':'沪铜1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1789', '513':'沪银1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1786', '513':'铅铝1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1785', '513':'石油1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1788', '513':'沪铜1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1789', '513':'沪银1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1786', '513':'铅铝1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1785', '513':'石油1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1788', '513':'沪铜1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1789', '513':'沪银1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1786', '513':'铅铝1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1785', '513':'石油1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1788', '513':'沪铜1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1789', '513':'沪银1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1786', '513':'铅铝1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1785', '513':'石油1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1788', '513':'沪铜1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1789', '513':'沪银1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1786', '513':'铅铝1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1785', '513':'石油1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1788', '513':'沪铜1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1789', '513':'沪银1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1786', '513':'铅铝1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1785', '513':'石油1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1788', '513':'沪铜1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1789', '513':'沪银1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1786', '513':'铅铝1789', '137': '123'},
                                       {'54': '上海', '55':'HZ', '512':'CU1785', '513':'石油1789', '137': '123'}
                                     ]
                                    }
                             };
                  callback(JSON.stringify(data));
                }
            };
            return obj;
        },
        SYS: function () {
            var obj1 = {
                startLoading: function () {},
                stopLoading: function () {}
            };
            return obj1;
        }
    }
}

//股东账号去重
function unique(array){
  var r = [];
  for(var i = 0, l = array.length; i < l; i++) {
    for(var j = i + 1; j < l; j++)
      if (array[i] === array[j]) j = ++i;
    r.push(array[i]);
  }
  return r;
}

//数组合并去重
function merge(a, b) {
  console.log(b);
  if(!b || b.length == 0)
    return a;
  var c = a.concat(b.filter(function (item) {
    return a.indexOf(item) < 0;
  }));
  return c;
}

//普通账户查询
function dbQuery (msg) {
  if (msg.jData['1'] < 0) {
    alert(msg.jData['2']);
  } else {
    console.log("dbQuery");
    accountInfo = msg.jData.data;
    arr1 = [];
    for (var i = 0, j = accountInfo.length; i < j; i++) {
      accountInfo[i]['GDZH'] = pbE.WT().wtGetGDZH(accountInfo[i]['54']);
      /*accountInfo[i]['GDZH'] = accountInfo[i]['54'];*/
      arr1.push(accountInfo[i]['GDZH']);
    }
    arr1 = unique(arr1);
    var bankContents = setLiCode(accountInfo);
    $('#code-ul').empty();
    $('#code-ul').append(bankContents);
    for (var i = 0, j = accountInfo.length; i < j; i++) {
      if (oBank.innerHTML == accountInfo[i]['GDZH'] && oCode.innerHTML == accountInfo[i]['512']) {
        //$('#max').val(accountInfo[i]['137']);
          doQueryMax("i");
        $('#name').val(accountInfo[i]['513']);
        $('#code-market').val(accountInfo[i]['54']);
        $('#num').val('');
        codeMax = $('#max').val();
        codeName = $('#name').val();
        codeMarket = $('#code-market').val();
      }
    }
  }
}

function dbTransfer (msg) {
  if (msg.jData['1'] < 0) {
    alert(msg.jData['2']);
  } else {
    alert('划转请求已发送！');
  }
}

//信用持仓查询
function positionQuery (msg) {
  if (msg.jData['1'] < 0) {
    alert(msg.jData['2']);
  } else {
    accountInfo2 = msg.jData.data;
    arr2 = [];
    for (var i = 0; i < accountInfo2.length; i++) {
      accountInfo2[i]['GDZH'] = pbE.WT().wtGetGDZH(accountInfo2[i]['54']);
      /*accountInfo2[i]['GDZH'] = accountInfo2[i]['54'];*/
      arr2.push(accountInfo2[i]['GDZH']);
    }
    arr2 = unique(arr2);
    console.log("arr2:"+ arr2);
    var bankContents2 = setLiCode2(accountInfo2);
    $('#code-ul').empty();
    $('#code-ul').append(bankContents2);
    for (var i = 0; i < accountInfo2.length; i++) {
      if (oBank.innerHTML == accountInfo2[i]['GDZH'] && oCode.innerHTML == accountInfo2[i]['63']) {
        //$('#max').val(accountInfo2[i]['137']);
          doQueryMax("j");
        $('#name').val(accountInfo2[i]['64']);
        $('#code-market').val(accountInfo2[i]['54']);
        $('#num').val('');
        codeMax = $('#max').val();
        codeName = $('#name').val();
        codeMarket = $('#code-market').val();
      }
    }
  }
}

function checkSpot (msg) {
  if (msg.jData['1'] < 0) {
    alert(msg.jData['2']);
  } else {
    $('.my-modal').addClass('hide');
    $('#currency').html($('#direction0').html()); //划转方向默认显示
    $('#direction').val($('#direction0').attr('value'));
    pbE.SYS().startLoading();
    pbE.WT().wtQueryStock(CID, JSON.stringify({}));
  }
}

function doQueryMax(direction){

    var param = {
        '512': oCode.innerHTML,  //证券代码
        '52': oBank.innerHTML,  //股东号
        '54': codeMarket,  //市场代码
        '626': direction,  //划转类别
        '161': pbE.WT().wtGetXWH(codeMarket),  //席位号
    };
    pbE.SYS().startLoading();
    console.log(param);
    pbE.WT().wtGeneralRequest(CID, 7107, JSON.stringify(param));

}

function queryMax(msg){
      console.log(msg);
    if (msg.jData['1'] < 0) {
        alert(msg.jData['2']);
    }else {
        var numObj = msg.jData.data;
        if(numObj && numObj.length>0)
        {
            $('#max').val(numObj[0]["250"]);
        }
    }
}

//设置转入或转出账户的下拉列表
function setLiCode(data) {
  var domStr = '', arr = [];
  //每个币种一条记录，如果一个银行有多个币种则有多条记录，合并相同银行账号的币种
  var account = {};
  for (var i = 0, l = data.length;i<l;i++) {
    var key = data[i]['512'];
    var accountAttr = {
      'GDZH': []
    };
    if (!account.hasOwnProperty(key)) {
      accountAttr['GDZH'].push(data[i]['GDZH']);
      accountAttr['512'] = data[i]['512'];
      accountAttr['54'] = data[i]['54'];
      accountAttr['513'] = data[i]['513'];
      accountAttr['137'] = data[i]['137'];
      account[key] = accountAttr;
    } else {
      if (account[key]['GDZH'].indexOf(data[i]['GDZH']) < 0) {
        account[key]['GDZH'].push(data[i]['GDZH']);
      }
    }
  } //合并结束
  var k = 0;
  for (var acc in account) {
    if (k == 0) {
      domStr += '<li value="' + acc + '" account="' + account[acc]['GDZH'] + '" market="' + account[acc]['54'] + '" code="' + account[acc]['512'] + '" name="' + account[acc]['513'] + '" max="' + account[acc]['137'] + '" class="hover">' + '<span class="b1">' + account[acc]['512'] + '</span></li>';
      oCode.innerHTML = account[acc]['512'];
      var bankContents = setLiBank(merge(account[acc]['GDZH'], arr1));
      $('#bank-ul').empty();
      $('#bank-ul').append(bankContents);
      /*$('#result-account').html(acc);
      $('#result-bank').html(account[acc]['216']);*/
      code = account[acc]['512']; codeAccount = account[acc]['GDZH']; codeName = account[acc]['513']; codeMax = account[acc]['137']; codeMarket = account[acc]['54'];
      k++;
    } else {
      domStr += '<li value="' + acc + '" account="' + account[acc]['GDZH'] + '" market="' + account[acc]['54'] + '" code="' + account[acc]['512'] + '" name="' + account[acc]['513'] + '" max="' + account[acc]['137'] + '">' + '<span class="b1">' + account[acc]['512'] + '</span></li>';
      k++;
    }
  }
  return domStr;
}

//设置转入或转出账户的下拉列表
function setLiCode2(data) {
  var domStr = '', arr = [];
  //每个币种一条记录，如果一个银行有多个币种则有多条记录，合并相同银行账号的币种
  var account = {};
  for (var i = 0, l = data.length;i<l;i++) {
    var key = data[i]['63'];
    var accountAttr = {
      'GDZH': []
    };
    if (!account.hasOwnProperty(key)) {
      accountAttr['GDZH'].push(data[i]['GDZH']);
      accountAttr['63'] = data[i]['63'];
      accountAttr['54'] = data[i]['54'];
      accountAttr['64'] = data[i]['64'];
      accountAttr['137'] = data[i]['137'];
      account[key] = accountAttr;
    } else {
      if (account[key]['GDZH'].indexOf(data[i]['GDZH']) < 0) {
        account[key]['GDZH'].push(data[i]['GDZH']);
      }
    }
  } //合并结束
  var k = 0;
  for (var acc in account) {
    if (k == 0) {
      domStr += '<li value="' + acc + '" account="' + account[acc]['GDZH'] + '" market="' + account[acc]['54'] + '" code="' + account[acc]['63'] + '" name="' + account[acc]['64'] + '" max="' + account[acc]['137'] + '" class="hover">' + '<span class="b1">' + account[acc]['63'] + '</span></li>';
      oCode.innerHTML = account[acc]['63'];
      var bankContents = setLiBank(merge(account[acc]['GDZH'], arr2));
      $('#bank-ul').empty();
      $('#bank-ul').append(bankContents);
      /*$('#result-account').html(acc);
      $('#result-bank').html(account[acc]['216']);*/
      code = account[acc]['63']; codeAccount = account[acc]['GDZH']; codeName = account[acc]['64']; codeMax = account[acc]['137']; codeMarket = account[acc]['54'];
      k++;
    } else {
      domStr += '<li value="' + acc + '" account="' + account[acc]['GDZH'] + '" market="' + account[acc]['54'] + '" code="' + account[acc]['63'] + '" name="' + account[acc]['64'] + '" max="' + account[acc]['137'] + '">' + '<span class="b1">' + account[acc]['63'] + '</span></li>';
      k++;
    }
  }
  return domStr;
}

//设置币种的下拉列表
function setLiBank(data) {
  var domStr = '';
  for (var i = 0, l = data.length; i < l; i++) {
    /*if (parseInt(data[i] + 1)) {*/
    if (i == 0) {
      domStr += '<li class="hover">' +  data[i] + '</li>';
      oBank.innerHTML = data[i];
    } else {
      domStr += '<li>' +  data[i] + '</li>';
    }/*}*/
  }
  return domStr;
}

function confirm() {
  var obj1 = document.getElementById("account");
  var obj2 = document.getElementById("pwd");
  if(pbUtils.JTrim(obj1.value) == '') {
    alert("请输入客户号！");
    return;
  } else if(pbUtils.JTrim(obj2.value) == '') {
    alert("请输入交易密码！");
    return;
  } else {
    var par = {
      '50': $('#account').val(),  //客户号
      '58': pbE.WT().wtEncrypt(CID,$('#pwd').val())  //交易密码
    };
  pbE.SYS().startLoading();
  pbE.WT().wtGeneralRequest(CID, 6150, JSON.stringify(par));
    /*alert(transfer['52'] + '***1' + transfer['512'] + '***2' + transfer['54'] + '***3' + transfer['617']);*/
  }
}

function confirmIn() {
  var obj = document.getElementById("num");
  if(pbUtils.JTrim(obj.value) == '') {
    alert("请输入划转数量！");
    return;
  } else {
    var transfer = {
      '512': oCode.innerHTML,  //证券代码
      '52': oBank.innerHTML,  //股东号
      '54': codeMarket,  //市场代码
      '616': $('#direction').val(),  //划转类别
      '617': $('#num').val(),  //划转数量
      '161': pbE.WT().wtGetXWH(codeMarket),  //席位号
    };
  pbE.SYS().startLoading();
  pbE.WT().wtGeneralRequest(CID, 7100, JSON.stringify(transfer));
    /*alert(transfer['52'] + '***1' + transfer['512'] + '***2' + transfer['54'] + '***3' + transfer['617']);*/
  }
}

var CID = pbE.WT().wtGetCurrentConnectionCID();
//获取席位号：pbEngine.getTradeXWH(content['54'])
var oBank = document.getElementById('bank');  //股东账号
var oCurrency = document.getElementById('currency');  //划转方向
var oCode = document.getElementById('code');  //证券代码
var fundPwd = '', bankPwd = '';
var code, codeAccount, codeMax, codeName, codeMarket;  //证券代码，股东账号，最大可划转数量，证券名称
var accountInfo, accountInfo2;
var arr1, arr2;

$(function () {
  var option = {
    callbacks: [{ fun: 7009, module: 90002, callback: function (msg) {dbQuery(msg);}},
                 {fun: 7100, module: 90002, callback: function (msg) {dbTransfer(msg);}},
                {fun: 6014, module: 90002, callback: function (msg) {positionQuery(msg);}},
                {fun: 6150, module: 90002, callback: function (msg) {checkSpot(msg);}},
                {fun: 7107, module: 90002, callback: function (msg) {queryMax(msg);}}
    ],

    reload: function () {},

    refresh: function () {
      $('.content').removeClass('hide');
      $('#alert').addClass('hide');
      var data = { '9': start.toString(), '10': end.toString() };
      pbE.SYS().startLoading();
      pbE.WT().wtGeneralRequest(CID, parseInt(conf.db.functionNO), JSON.stringify(data));
    },

    doShow: function (flag) {
      if (!flag) {
        pbE.SYS().stopLoading();
      }
    },

    fresh: function () {}
  };

  pbPage.initPage(option);

  var gtCode = pbE.WT().wtGetJYGT();
  if (gtCode == '101' || gtCode == '105') {
    $('.my-modal').removeClass('hide');
    var khh = JSON.parse(pbE.WT().wtLoginRe(CID)).data[0]['50'];
    if(khh && khh != '' && khh != undefined){
      $('#account').val(khh)
    }
  } else {
    $('#currency').html($('#direction0').html()); //划转方向默认显示
    $('#direction').val($('#direction0').attr('value'));
    pbE.SYS().startLoading();
    pbE.WT().wtQueryStock(CID, JSON.stringify({}));
  }

  $(document).ready(function () {
    $('body').click(function () {
      $('#bank-ul').addClass('hide');
      $('#currency-ul').addClass('hide');
      $('#code-ul').addClass('hide');
    });
    $('.code-div').click(function (e) {
      $('#currency-ul').addClass('hide');
      $('#bank-ul').addClass('hide');
      $('#code-ul').toggleClass('hide');
      $('#bank').focus();
      e.stopPropagation();
    });
    $('#code-ul').on('click', 'li', function () {
      code = $(this).attr('code');
      codeAccount = $(this).attr('account');
      codeName = $(this).attr('name');
      codeMax = $(this).attr('max');
      codeMarket = $(this).attr('market');
      $('#code').val($(this).attr('code'));
      $('#code-name').val($(this).attr('name'));
      $('#code-account').val($(this).attr('account'));
      $('#code-market').val($(this).attr('market'));
      $('#code-max').val($(this).attr('max'));
      $('#code-ul .hover').removeClass('hover');
      $(this).addClass('hover');
      oCode.innerHTML = $('#code').val();
      /*var bankContents = setLiBank(merge($('#code-account').val().split(','));
      $('#bank-ul').empty();
      $('#bank-ul').append(bankContents);*/
      if ($('#direction').val() == 'i') {

          doQueryMax("i");

         var bankContents = setLiBank(merge($('#code-account').val().split(','), arr2));
        $('#bank-ul').empty();
        $('#bank-ul').append(bankContents);
        for (var i = 0; i < accountInfo.length; i++) {
           console.log(accountInfo[i]);
          if (oBank.innerHTML == accountInfo[i]['GDZH'] && oCode.innerHTML == accountInfo[i]['512']) {
              //$('#max').val(accountInfo[i]['137']);
              $('#name').val(accountInfo[i]['513']);
              $('#code-market').val(accountInfo[i]['54']);
            $('#num').val('');
            codeMax = $('#max').val();
            codeName = $('#name').val();
            codeMarket = $('#code-market').val();
          }
        }
      }
      if ($('#direction').val() == 'j') {
          doQueryMax("j");
        var bankContents = setLiBank(merge($('#code-account').val().split(','), arr1));
        $('#bank-ul').empty();
        $('#bank-ul').append(bankContents);
        for (var i = 0; i < accountInfo2.length; i++) {
            console.log("code：");
            console.log(accountInfo2[i]);
          if (oBank.innerHTML == accountInfo2[i]['GDZH'] && oCode.innerHTML == accountInfo2[i]['63']) {
             console.log("来了");
              //$('#max').val(accountInfo2[i]['137']);
              $('#name').val(accountInfo2[i]['64']);
              $('#code-market').val(accountInfo2[i]['54']);

            $('#num').val('');
            codeMax = $('#max').val();
            codeName = $('#name').val();
            codeMarket = $('#code-market').val();
          }
        }
      }
    });
    $('.currency-div').click(function (e) {
      $('#bank-ul').addClass('hide');
      $('#code-ul').addClass('hide');
      $('#currency-ul').toggleClass('hide');
      $('#currency').focus();
      e.stopPropagation();
    });
    $('#currency-ul').on('click', 'li', function () {
      $('#currency').html($(this).val());
      $('#direction').val($(this).attr('value'));
      console.log("direction"+$('#direction').val())
      $('#currency-ul .hover').removeClass('hover');
      $(this).addClass('hover');
      oCurrency.innerHTML = $(this).html();
      if ($('#direction').val() == 'i') {
        $('#bank-ul').empty();
        $('#code-ul').empty();
        $('#max').val("");
        $('#num').val("");
        $('#name').val("");
        oCode.innerHTML = "";
        oBank.innerHTML = "";
        $('#code-market').val("");
        /*callback(JSON.stringify(data1));*/
        pbE.SYS().startLoading();
        pbE.WT().wtGeneralRequest(CID, 7009, JSON.stringify({}));

      } else if ($('#direction').val() == 'j') {
        $('#bank-ul').empty();
        $('#code-ul').empty();
        $('#max').val("");
        $('#num').val("");
        $('#name').val("");
        oCode.innerHTML = "";
        oBank.innerHTML = "";
        $('#code-market').val("");
        /*callback(JSON.stringify(data2));*/
        pbE.SYS().startLoading();
        pbE.WT().wtQueryStock(CID, JSON.stringify({}));
      }
    });
    $('.bank-div').click(function (e) {
      $('#code-ul').addClass('hide');
      $('#currency-ul').addClass('hide');
      $('#bank-ul').toggleClass('hide');
      $('#bank').focus();
      e.stopPropagation();
    });
    $('#bank-ul').on('click', 'li', function () {
      $('#bank').html($(this).val());
      $('#bank-ul .hover').removeClass('hover');
      $(this).addClass('hover');
      oBank.innerHTML = $(this).html();
      if ($('#direction').val() == 'i') {
        console.log("bank-ul-i");
        for (var i = 0; i < accountInfo.length; i++) {
          // if (oBank.innerHTML == accountInfo2[i]['GDZH'] && oCode.innerHTML == accountInfo2[i]['63']) {
          //   $('#max').val(accountInfo2[i]['137']);
          //   $('#name').val(accountInfo2[i]['64']);
          //   $('#code-market').val(accountInfo2[i]['54']);
          //   $('#num').val('');
          //   codeMax = $('#max').val();
          //   codeName = $('#name').val();
          //   codeMarket = $('#code-market').val();
          // }
            if (oBank.innerHTML == accountInfo[i]['GDZH']) {
                oCode.innerHTML = accountInfo[i]['512'];
                //$('#max').val(accountInfo[i]['137']);
                doQueryMax("i");
                $('#name').val(accountInfo[i]['513']);
                $('#code-market').val(accountInfo[i]['54']);
                $('#num').val('');
                codeMax = $('#max').val();
                codeName = $('#name').val();
                codeMarket = $('#code-market').val();
                break;
            }
        }
      }
      if ($('#direction').val() == 'j') {
          console.log("bank-ul-j");
        for (var i = 0; i < accountInfo2.length; i++) {
          // if (oBank.innerHTML == accountInfo[i]['GDZH'] && oCode.innerHTML == accountInfo[i]['512']) {
          //   $('#max').val(accountInfo[i]['137']);
          //   $('#name').val(accountInfo[i]['513']);
          //   $('#code-market').val(accountInfo[i]['54']);
          //   $('#num').val('');
          //   codeMax = $('#max').val();
          //   codeName = $('#name').val();
          //   codeMarket = $('#code-market').val();
          // }
            if (oBank.innerHTML == accountInfo2[i]['GDZH']) {
                oCode.innerHTML = accountInfo2[i]['63'];
                doQueryMax("j");
                //$('#max').val(accountInfo2[i]['137']);
                $('#name').val(accountInfo2[i]['64']);
                $('#code-market').val(accountInfo2[i]['54']);
                $('#num').val('');
                codeMax = $('#max').val();
                codeName = $('#name').val();
                codeMarket = $('#code-market').val();
                break;
            }

        }
      }
    });
  });

  $('#total').click(function() {
    $('#num').val($('#max').val());
  });

  if (!isApp) {
    $('#goBack').click(function () {
      location.href = document.referrer;
    })
  } /*else{
    $('#goBack').click(function () {
      location.href = 'goBack';
    })
  }*/
});